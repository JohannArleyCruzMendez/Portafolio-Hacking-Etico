# Pr√°ctica 2.3: Elaboraci√≥n de Paquetes con Scapy

## üéØ Objetivo
Utilizar **Scapy**, una potente herramienta de manipulaci√≥n de paquetes en Python, para crear, enviar y analizar paquetes de red personalizados. El objetivo es comprender la estructura interna de los protocolos TCP/IP y realizar t√©cnicas de reconocimiento activo manual (como el escaneo de puertos) sin depender de herramientas automatizadas.

## üõ†Ô∏è Herramientas Utilizadas
* **Scapy:** Framework de Python para manipulaci√≥n de paquetes.
* **Kali Linux:** Entorno de ataque.
* **Wireshark/Tcpdump:** (Impl√≠cito en las funciones de `sniff` de Scapy).

## üìù Desarrollo de la Pr√°ctica

### 1. Exploraci√≥n de Protocolos y Estructuras
Se inici√≥ la herramienta en modo interactivo para analizar c√≥mo se construyen los paquetes a nivel de c√≥digo.
* **Comando:** `ls(IP)`
* **An√°lisis:** Se compar√≥ la estructura te√≥rica del encabezado IPv4 con la implementaci√≥n en Scapy.
    * **Hallazgo:** Scapy utiliza abreviaturas t√©cnicas para los campos (ej. `src` en lugar de *Source Address*, `ttl` en lugar de *Time To Live*), lo cual agiliza la escritura de scripts.
    * **Spoofing:** Se identific√≥ que modificando el campo `src` es posible falsificar la direcci√≥n de origen para realizar ataques de suplantaci√≥n o DoS reflejado.

### 2. Interceptaci√≥n de Tr√°fico (Sniffing)
Se configur√≥ Scapy para escuchar el tr√°fico de la red interna y capturar la interacci√≥n real de protocolos.
* **Comando:** `sniff(iface="br-internal", count=10)`
* **An√°lisis del Tr√°fico:**
    * Se capturaron paquetes **DNS** (resoluci√≥n de nombres) y **ICMP** (Echo Request/Reply).
    * Se observ√≥ el protocolo **ARP** en acci√≥n, resolviendo direcciones MAC para la comunicaci√≥n local.
* **Exportaci√≥n:** Se guard√≥ la captura en formato `.pcap` para an√°lisis forense posterior con `wrpcap("capture1.pcap", a)`.

### 3. Inyecci√≥n de Paquetes ICMP Personalizados
En lugar de usar la herramienta `ping` est√°ndar, se "fabric√≥" un paquete ICMP manualmente, inyectando datos arbitrarios en la carga √∫til (payload).
* **Comando de Ataque:**
  ```python
  send(IP(dst="10.6.6.23")/ICMP()/"Esto es una prueba de Johann")
Evidencia en la Captura: Al analizar el paquete capturado (a[2]), se verific√≥ que el campo load conten√≠a el texto inyectado:

load = 'Esto es una prueba de Johann'

Implicaci√≥n de Seguridad: Esto demuestra c√≥mo es posible utilizar protocolos permitidos (como ICMP) para exfiltrar datos o crear canales de comunicaci√≥n encubiertos (ICMP Tunneling).

4. Escaneo de Puertos Manual (TCP SYN)
Se replic√≥ el funcionamiento de un escaneo sigiloso (Stealth Scan) construyendo un paquete TCP con el flag SYN activado.

Objetivo: Verificar si el puerto 445 (SMB) en 10.6.6.23 estaba abierto.

Comando:

Python

send(IP(dst="10.6.6.23")/TCP(dport=445, flags="S"))
An√°lisis de la Respuesta: Se captur√≥ la respuesta del servidor (10.6.6.23) para interpretar el estado del puerto.

Paquete Recibido: Ether / IP / TCP 10.6.6.23 > 10.6.6.1 flags=SA

Interpretaci√≥n: El flag SA corresponde a SYN-ACK.

Conclusi√≥n: El puerto 445 est√° ABIERTO. Si hubiera estado cerrado, la respuesta habr√≠a contenido el flag R (RST/Reset).

üöÄ Conclusiones
El uso de Scapy permite un control granular sobre cada bit que se transmite en la red. A diferencia de Nmap, que automatiza el proceso, Scapy permite:

Entender la mec√°nica exacta del Three-Way Handshake.

Realizar escaneos manuales que pueden ser m√°s dif√≠ciles de detectar por IDS/Firewalls b√°sicos.

Simular comportamientos de red an√≥malos para probar la robustez de los sistemas defensivos.
